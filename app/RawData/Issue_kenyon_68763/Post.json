{
    "active_lock_reason": "too heated",
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "##### SUMMARY\r\n#67429 (included in Ansible v2.9.6) causes a massive performance penalty compared to Ansible v2.9.5. I have a project making heavy use of Ansible's `template` module. With v2.9.5 it takes about 15 seconds to render a file. With v2.9.6, it takes about 9 minutes. Reverting the change in #67429 (just changing `if cache and only_one:` back to `if cache:`) restores the v2.9.5 performance.\r\n\r\n##### ISSUE TYPE\r\n- Bug Report\r\n\r\n##### COMPONENT NAME\r\n`lib/ansible/template/__init__.py`\r\n\r\n##### ANSIBLE VERSION\r\n<!--- Paste verbatim output from \"ansible --version\" between quotes -->\r\n```paste below\r\nansible 2.9.6\r\n  config file = /users/kenyon/git/tni4/ansible.cfg\r\n  configured module search path = ['/users/kenyon/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']\r\n  ansible python module location = /users/kenyon/.local/share/virtualenvs/tni4-I44CyCAv/lib/python3.6/site-packages/ansible\r\n  executable location = /users/kenyon/.local/share/virtualenvs/tni4-I44CyCAv/bin/ansible\r\n  python version = 3.6.8 (default, Apr 25 2019, 21:02:35) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]\r\n```\r\n\r\n##### CONFIGURATION\r\n<!--- Paste verbatim output from \"ansible-config dump --only-changed\" between quotes -->\r\n```paste below\r\nDEFAULT_HOST_LIST(/users/kenyon/git/tni4/ansible.cfg) = ['/users/kenyon/git/tni4/hosts']\r\n```\r\n\r\n##### OS / ENVIRONMENT\r\n<!--- Provide all relevant information below, e.g. target OS versions, network device firmware, etc. -->\r\nCentOS 7\r\n\r\n##### STEPS TO REPRODUCE\r\n<!--- Describe exactly how to reproduce the problem, using a minimal test-case -->\r\nUse large templates with lots of Jinja code. I am rendering configuration files for network devices, so the end resulting rendered files are around 2000 lines or less, but the templates use a lot of Jinja features.\r\n\r\n##### EXPECTED RESULTS\r\n<!--- Describe what you expected to happen when running the steps above -->\r\nNo performance regression.\r\n\r\n##### ACTUAL RESULTS\r\n<!--- Describe what actually happened. If possible run with extra verbosity (-vvvv) -->\r\nPerformance regression.",
    "closed_at": null,
    "closed_by": null,
    "comments": 18,
    "comments_url": "https://api.github.com/repos/ansible/ansible/issues/68763/comments",
    "created_at": "2020-04-08T07:45:58Z",
    "events_url": "https://api.github.com/repos/ansible/ansible/issues/68763/events",
    "html_url": "https://github.com/ansible/ansible/issues/68763",
    "id": 596377320,
    "labels": [
        {
            "color": "fbca04",
            "default": false,
            "description": null,
            "id": 383076471,
            "name": "python3",
            "node_id": "MDU6TGFiZWwzODMwNzY0NzE=",
            "url": "https://api.github.com/repos/ansible/ansible/labels/python3"
        },
        {
            "color": "555555",
            "default": false,
            "description": null,
            "id": 420038402,
            "name": "performance",
            "node_id": "MDU6TGFiZWw0MjAwMzg0MDI=",
            "url": "https://api.github.com/repos/ansible/ansible/labels/performance"
        },
        {
            "color": "ededed",
            "default": false,
            "description": "This issue/PR relates to code supported by the Ansible Engineering Team.",
            "id": 636352796,
            "name": "support:core",
            "node_id": "MDU6TGFiZWw2MzYzNTI3OTY=",
            "url": "https://api.github.com/repos/ansible/ansible/labels/support:core"
        },
        {
            "color": "fbca04",
            "default": true,
            "description": "This issue/PR relates to a bug.",
            "id": 785271699,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3ODUyNzE2OTk=",
            "url": "https://api.github.com/repos/ansible/ansible/labels/bug"
        },
        {
            "color": "e3ed5e",
            "default": false,
            "description": "Priority 3 - Approved, No Time Limitation",
            "id": 1126594180,
            "name": "P3",
            "node_id": "MDU6TGFiZWwxMTI2NTk0MTgw",
            "url": "https://api.github.com/repos/ansible/ansible/labels/P3"
        },
        {
            "color": "4071a5",
            "default": false,
            "description": "Files category",
            "id": 1255972080,
            "name": "files",
            "node_id": "MDU6TGFiZWwxMjU1OTcyMDgw",
            "url": "https://api.github.com/repos/ansible/ansible/labels/files"
        },
        {
            "color": "5319e7",
            "default": false,
            "description": "This issue/PR affects Ansible v2.9",
            "id": 1316917295,
            "name": "affects_2.9",
            "node_id": "MDU6TGFiZWwxMzE2OTE3Mjk1",
            "url": "https://api.github.com/repos/ansible/ansible/labels/affects_2.9"
        }
    ],
    "labels_url": "https://api.github.com/repos/ansible/ansible/issues/68763/labels{/name}",
    "locked": true,
    "milestone": null,
    "node_id": "MDU6SXNzdWU1OTYzNzczMjA=",
    "number": 68763,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/ansible/ansible/issues/68763/reactions"
    },
    "repository_url": "https://api.github.com/repos/ansible/ansible",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/ansible/ansible/issues/68763/timeline",
    "title": "v2.9.6 templating performance regression due to caching change in #67429",
    "updated_at": "2020-08-25T22:53:38Z",
    "url": "https://api.github.com/repos/ansible/ansible/issues/68763",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/68514?v=4",
        "events_url": "https://api.github.com/users/kenyon/events{/privacy}",
        "followers_url": "https://api.github.com/users/kenyon/followers",
        "following_url": "https://api.github.com/users/kenyon/following{/other_user}",
        "gists_url": "https://api.github.com/users/kenyon/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/kenyon",
        "id": 68514,
        "login": "kenyon",
        "node_id": "MDQ6VXNlcjY4NTE0",
        "organizations_url": "https://api.github.com/users/kenyon/orgs",
        "received_events_url": "https://api.github.com/users/kenyon/received_events",
        "repos_url": "https://api.github.com/users/kenyon/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/kenyon/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/kenyon/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/kenyon"
    }
}