{
    "active_lock_reason": "too heated",
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "This patch wires up Metal Binary Archives for Mac and iOS. Metal Binary Archives\r\nare used to cache pipeline state objects generated at runtime on the device and\r\nserialize them to disk when rendering is paused. In this prototype, the binary\r\narchives are serialized to disk when the application moves into the background.\r\nOn the next launch of the application, the serialized representation of the\r\narchives is used for the creation of new pipeline state objects.\r\n\r\nPer the [details in the linked issue][1], I do not recommend we land this patch.\r\nThis PR is just meant to be a record of the prototyping work done to evaluate\r\nMetal Binary Archives for Flutter.\r\n\r\n[1]: https://github.com/flutter/flutter/issues/60267#issuecomment-762786388\r\n\r\n## Observations\r\n\r\nOnce patched in, the following observations can be made while running a Flutter application.\r\n\r\n* After first launch, the application caches directory should contain a `.metallib` file with the following format. `flutter_engine_<engine_version>_<skia_version>_<index>.metallib`. This was done so any changes to the Flutter engine or the Skia version would not run the risk of using invalid cached contents. The file ([example](https://github.com/flutter/engine/files/5865817/flutter_engine_08daa2c8962687253fbcbd812d08d70c34c86721_069e484cc3b9518f115312c065a6f9c843b0839a_0.metallib.zip)) seems to be a Mach-O binary. This is consistent with Apple's recommendation that the `lipo` tool be used to combine archives harvested from devices of different GPU families.\r\n* This file will get updated every time the application is backgrounded and will get reused when the application is launched.\r\n* To prevent any issues with threading (I could find no mention in the docs about the thread safety aspects of any of the APIs) only raster thread operations will using this archive.\r\n* One open question not answered in my linked comment was how much these archives would help for jank during subsequent application launches (as seeding the archive for first launch is a no-go). I tried to find determine this by making sure the cache was seeded and launching the application again. My hope was to see a reduction in the `GrMtlPipelineStateBuilder::finalize` trace in Observatory. This [did not materialize (trace is from a warmed up archive)](https://github.com/flutter/engine/files/5865862/warmed_cached_pipeline_state_extra_skia_traces.json.zip). This seems to be because the primary cause of jank in pipeline state setup is the construction of the Metal shader library (SKSL -> MSL -> MTLLibrary (AIR?)) and not the pipeline state object construction. An annotated version of one of the traces is as follows:\r\n![Screen Shot 2021-01-25 at 2 24 51 AM](https://user-images.githubusercontent.com/44085/105694897-5058fc80-5eb6-11eb-8440-5b6f973abe0a.png)",
    "closed_at": "2021-10-19T23:18:37Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/551196?v=4",
        "events_url": "https://api.github.com/users/Hixie/events{/privacy}",
        "followers_url": "https://api.github.com/users/Hixie/followers",
        "following_url": "https://api.github.com/users/Hixie/following{/other_user}",
        "gists_url": "https://api.github.com/users/Hixie/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/Hixie",
        "id": 551196,
        "login": "Hixie",
        "node_id": "MDQ6VXNlcjU1MTE5Ng==",
        "organizations_url": "https://api.github.com/users/Hixie/orgs",
        "received_events_url": "https://api.github.com/users/Hixie/received_events",
        "repos_url": "https://api.github.com/users/Hixie/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/Hixie/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Hixie/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/Hixie"
    },
    "comments": 57,
    "comments_url": "https://api.github.com/repos/flutter/engine/issues/23914/comments",
    "created_at": "2021-01-25T10:40:48Z",
    "draft": true,
    "events_url": "https://api.github.com/repos/flutter/engine/issues/23914/events",
    "html_url": "https://github.com/flutter/engine/pull/23914",
    "id": 793264270,
    "labels": [
        {
            "color": "0e8a16",
            "default": false,
            "description": null,
            "id": 487933577,
            "name": "cla: yes",
            "node_id": "MDU6TGFiZWw0ODc5MzM1Nzc=",
            "url": "https://api.github.com/repos/flutter/engine/labels/cla:%20yes"
        },
        {
            "color": "000000",
            "default": false,
            "description": "Not ready (yet) for review!",
            "id": 1244956084,
            "name": "Work in progress (WIP)",
            "node_id": "MDU6TGFiZWwxMjQ0OTU2MDg0",
            "url": "https://api.github.com/repos/flutter/engine/labels/Work%20in%20progress%20(WIP)"
        }
    ],
    "labels_url": "https://api.github.com/repos/flutter/engine/issues/23914/labels{/name}",
    "locked": true,
    "milestone": null,
    "node_id": "MDExOlB1bGxSZXF1ZXN0NTYwOTgxNTgz",
    "number": 23914,
    "performed_via_github_app": null,
    "pull_request": {
        "diff_url": "https://github.com/flutter/engine/pull/23914.diff",
        "html_url": "https://github.com/flutter/engine/pull/23914",
        "merged_at": null,
        "patch_url": "https://github.com/flutter/engine/pull/23914.patch",
        "url": "https://api.github.com/repos/flutter/engine/pulls/23914"
    },
    "reactions": {
        "+1": 2,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 2,
        "url": "https://api.github.com/repos/flutter/engine/issues/23914/reactions"
    },
    "repository_url": "https://api.github.com/repos/flutter/engine",
    "state": "closed",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/flutter/engine/issues/23914/timeline",
    "title": "[Prototype] [Do NOT Merge] Binary Metal Archive Prototype for iOS/Mac.",
    "updated_at": "2022-07-07T22:14:57Z",
    "url": "https://api.github.com/repos/flutter/engine/issues/23914",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/44085?v=4",
        "events_url": "https://api.github.com/users/chinmaygarde/events{/privacy}",
        "followers_url": "https://api.github.com/users/chinmaygarde/followers",
        "following_url": "https://api.github.com/users/chinmaygarde/following{/other_user}",
        "gists_url": "https://api.github.com/users/chinmaygarde/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/chinmaygarde",
        "id": 44085,
        "login": "chinmaygarde",
        "node_id": "MDQ6VXNlcjQ0MDg1",
        "organizations_url": "https://api.github.com/users/chinmaygarde/orgs",
        "received_events_url": "https://api.github.com/users/chinmaygarde/received_events",
        "repos_url": "https://api.github.com/users/chinmaygarde/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/chinmaygarde/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/chinmaygarde/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/chinmaygarde"
    }
}