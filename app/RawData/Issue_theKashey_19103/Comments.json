[
    {
        "author_association": "NONE",
        "body": "The idea of StrictMode that it double renders (among other things) all components trying to catch some unintended side-effects. So, if something works without StrictMode, but breaks with it then here you go: you just found a bug in your code! (or in your case, in `react-stripe-js`)",
        "created_at": "2020-06-09T07:27:13Z",
        "html_url": "https://github.com/facebook/react/issues/19103#issuecomment-641089222",
        "id": 641089222,
        "issue_url": "https://api.github.com/repos/facebook/react/issues/19103",
        "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTA4OTIyMg==",
        "performed_via_github_app": null,
        "reactions": {
            "+1": 0,
            "-1": 0,
            "confused": 0,
            "eyes": 0,
            "heart": 0,
            "hooray": 0,
            "laugh": 0,
            "rocket": 0,
            "total_count": 0,
            "url": "https://api.github.com/repos/facebook/react/issues/comments/641089222/reactions"
        },
        "updated_at": "2020-06-09T07:27:13Z",
        "url": "https://api.github.com/repos/facebook/react/issues/comments/641089222",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/2993861?v=4",
            "events_url": "https://api.github.com/users/vkurchatkin/events{/privacy}",
            "followers_url": "https://api.github.com/users/vkurchatkin/followers",
            "following_url": "https://api.github.com/users/vkurchatkin/following{/other_user}",
            "gists_url": "https://api.github.com/users/vkurchatkin/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/vkurchatkin",
            "id": 2993861,
            "login": "vkurchatkin",
            "node_id": "MDQ6VXNlcjI5OTM4NjE=",
            "organizations_url": "https://api.github.com/users/vkurchatkin/orgs",
            "received_events_url": "https://api.github.com/users/vkurchatkin/received_events",
            "repos_url": "https://api.github.com/users/vkurchatkin/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/vkurchatkin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/vkurchatkin/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/vkurchatkin"
        }
    },
    {
        "author_association": "CONTRIBUTOR",
        "body": "Before opening this issue I was reading thought existing issues, and there were many about double rendering. And look like it is a root case! Thank you for pointing on it yet again.\r\n```\r\n  if (!final.current) {\r\n    if (parsed.tag === 'sync') {\r\n      final.current = true; // \ud83d\udc48 this will prevent `setContext` to be called \"second time\"\r\n      setContext({\r\n        stripe: parsed.stripe,\r\n        elements: parsed.stripe.elements(options),\r\n      });\r\n    }\r\n```\r\nIn other  words - React will render component once, and it will do it \"properly\", and then it will render it second time, but __updated ref__ will amend the behavior, and `state` will not be updated. And that's why promise based code is working well - it's just \"out of double rendering cycle\".\r\n\r\nHowever this means two things:\r\n- `react` is not reporting about  the issue with Strict it might discovered.\r\n- `StrictMode` is not \"refs-compatible\", and it's not safe to use it.\r\n\r\n\ud83d\udc46 and that sounds like a really big bug, as long as refs are first-class citizens.",
        "created_at": "2020-06-09T07:35:26Z",
        "html_url": "https://github.com/facebook/react/issues/19103#issuecomment-641093612",
        "id": 641093612,
        "issue_url": "https://api.github.com/repos/facebook/react/issues/19103",
        "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTA5MzYxMg==",
        "performed_via_github_app": null,
        "reactions": {
            "+1": 0,
            "-1": 0,
            "confused": 0,
            "eyes": 0,
            "heart": 0,
            "hooray": 0,
            "laugh": 0,
            "rocket": 0,
            "total_count": 0,
            "url": "https://api.github.com/repos/facebook/react/issues/comments/641093612/reactions"
        },
        "updated_at": "2020-06-09T07:35:26Z",
        "url": "https://api.github.com/repos/facebook/react/issues/comments/641093612",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/582410?v=4",
            "events_url": "https://api.github.com/users/theKashey/events{/privacy}",
            "followers_url": "https://api.github.com/users/theKashey/followers",
            "following_url": "https://api.github.com/users/theKashey/following{/other_user}",
            "gists_url": "https://api.github.com/users/theKashey/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/theKashey",
            "id": 582410,
            "login": "theKashey",
            "node_id": "MDQ6VXNlcjU4MjQxMA==",
            "organizations_url": "https://api.github.com/users/theKashey/orgs",
            "received_events_url": "https://api.github.com/users/theKashey/received_events",
            "repos_url": "https://api.github.com/users/theKashey/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/theKashey/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/theKashey/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/theKashey"
        }
    },
    {
        "author_association": "NONE",
        "body": "> StrictMode is not \"refs-compatible\", and it's not safe to use it.\r\n\r\nStrictMode is \"refs-compatible\", but you need to follow the rules around refs, e.g. not mutating them in render (except for lazy initialization)\r\n\r\n> react is not reporting about the issue with Strict it might discovered.\r\n\r\nUnfortunately, that's not possible. StrictMode doesn't have any idea it has discovered anything. It is up to the developer to figure that out.",
        "created_at": "2020-06-09T07:43:20Z",
        "html_url": "https://github.com/facebook/react/issues/19103#issuecomment-641097791",
        "id": 641097791,
        "issue_url": "https://api.github.com/repos/facebook/react/issues/19103",
        "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTA5Nzc5MQ==",
        "performed_via_github_app": null,
        "reactions": {
            "+1": 0,
            "-1": 0,
            "confused": 0,
            "eyes": 0,
            "heart": 0,
            "hooray": 0,
            "laugh": 0,
            "rocket": 0,
            "total_count": 0,
            "url": "https://api.github.com/repos/facebook/react/issues/comments/641097791/reactions"
        },
        "updated_at": "2020-06-09T07:43:20Z",
        "url": "https://api.github.com/repos/facebook/react/issues/comments/641097791",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/2993861?v=4",
            "events_url": "https://api.github.com/users/vkurchatkin/events{/privacy}",
            "followers_url": "https://api.github.com/users/vkurchatkin/followers",
            "following_url": "https://api.github.com/users/vkurchatkin/following{/other_user}",
            "gists_url": "https://api.github.com/users/vkurchatkin/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/vkurchatkin",
            "id": 2993861,
            "login": "vkurchatkin",
            "node_id": "MDQ6VXNlcjI5OTM4NjE=",
            "organizations_url": "https://api.github.com/users/vkurchatkin/orgs",
            "received_events_url": "https://api.github.com/users/vkurchatkin/received_events",
            "repos_url": "https://api.github.com/users/vkurchatkin/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/vkurchatkin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/vkurchatkin/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/vkurchatkin"
        }
    },
    {
        "author_association": "CONTRIBUTOR",
        "body": "Isn't it supposed to [throw some warnings](https://reactjs.org/docs/strict-mode.html), not break an application without any notice?\r\n\r\nIn any case probably the root cause is calling `setState` from a render, not `useEffect`, which probably was made to allow only one call, and `useReducer` would solve that issue in a better way.\r\n\r\nProbably that's why the rest our Application is working - we do not using update-in-render pattern stripe has used.",
        "created_at": "2020-06-09T08:38:10Z",
        "html_url": "https://github.com/facebook/react/issues/19103#issuecomment-641127423",
        "id": 641127423,
        "issue_url": "https://api.github.com/repos/facebook/react/issues/19103",
        "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTEyNzQyMw==",
        "performed_via_github_app": null,
        "reactions": {
            "+1": 0,
            "-1": 0,
            "confused": 0,
            "eyes": 0,
            "heart": 0,
            "hooray": 0,
            "laugh": 0,
            "rocket": 0,
            "total_count": 0,
            "url": "https://api.github.com/repos/facebook/react/issues/comments/641127423/reactions"
        },
        "updated_at": "2020-06-09T08:38:10Z",
        "url": "https://api.github.com/repos/facebook/react/issues/comments/641127423",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/582410?v=4",
            "events_url": "https://api.github.com/users/theKashey/events{/privacy}",
            "followers_url": "https://api.github.com/users/theKashey/followers",
            "following_url": "https://api.github.com/users/theKashey/following{/other_user}",
            "gists_url": "https://api.github.com/users/theKashey/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/theKashey",
            "id": 582410,
            "login": "theKashey",
            "node_id": "MDQ6VXNlcjU4MjQxMA==",
            "organizations_url": "https://api.github.com/users/theKashey/orgs",
            "received_events_url": "https://api.github.com/users/theKashey/received_events",
            "repos_url": "https://api.github.com/users/theKashey/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/theKashey/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/theKashey/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/theKashey"
        }
    },
    {
        "author_association": "NONE",
        "body": "> Isn't it supposed to throw some warnings, not break an application without any notice?\r\n\r\nIs shows warning when you are using deprecated APIs and such. The idea of double-invoking is exactly that it might break something without any notice. \r\n\r\n",
        "created_at": "2020-06-09T08:41:02Z",
        "html_url": "https://github.com/facebook/react/issues/19103#issuecomment-641129113",
        "id": 641129113,
        "issue_url": "https://api.github.com/repos/facebook/react/issues/19103",
        "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTEyOTExMw==",
        "performed_via_github_app": null,
        "reactions": {
            "+1": 0,
            "-1": 0,
            "confused": 0,
            "eyes": 0,
            "heart": 0,
            "hooray": 0,
            "laugh": 0,
            "rocket": 0,
            "total_count": 0,
            "url": "https://api.github.com/repos/facebook/react/issues/comments/641129113/reactions"
        },
        "updated_at": "2020-06-09T08:41:02Z",
        "url": "https://api.github.com/repos/facebook/react/issues/comments/641129113",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/2993861?v=4",
            "events_url": "https://api.github.com/users/vkurchatkin/events{/privacy}",
            "followers_url": "https://api.github.com/users/vkurchatkin/followers",
            "following_url": "https://api.github.com/users/vkurchatkin/following{/other_user}",
            "gists_url": "https://api.github.com/users/vkurchatkin/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/vkurchatkin",
            "id": 2993861,
            "login": "vkurchatkin",
            "node_id": "MDQ6VXNlcjI5OTM4NjE=",
            "organizations_url": "https://api.github.com/users/vkurchatkin/orgs",
            "received_events_url": "https://api.github.com/users/vkurchatkin/received_events",
            "repos_url": "https://api.github.com/users/vkurchatkin/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/vkurchatkin/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/vkurchatkin/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/vkurchatkin"
        }
    },
    {
        "author_association": "COLLABORATOR",
        "body": "> Isn't it supposed to throw some warnings, not break an application without any notice?\r\n\r\nThe page uses different wording for side effect issues. If it could detect them, it would use the same wording:\r\n\r\n> Strict mode can\u2019t automatically detect side effects for you, but it can help you spot them by making them a little more deterministic.\r\n\r\n-- https://reactjs.org/docs/strict-mode.html#detecting-unexpected-side-effects",
        "created_at": "2020-06-09T08:53:44Z",
        "html_url": "https://github.com/facebook/react/issues/19103#issuecomment-641136661",
        "id": 641136661,
        "issue_url": "https://api.github.com/repos/facebook/react/issues/19103",
        "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTEzNjY2MQ==",
        "performed_via_github_app": null,
        "reactions": {
            "+1": 0,
            "-1": 0,
            "confused": 0,
            "eyes": 0,
            "heart": 0,
            "hooray": 0,
            "laugh": 0,
            "rocket": 0,
            "total_count": 0,
            "url": "https://api.github.com/repos/facebook/react/issues/comments/641136661/reactions"
        },
        "updated_at": "2020-06-09T08:53:44Z",
        "url": "https://api.github.com/repos/facebook/react/issues/comments/641136661",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/12292047?v=4",
            "events_url": "https://api.github.com/users/eps1lon/events{/privacy}",
            "followers_url": "https://api.github.com/users/eps1lon/followers",
            "following_url": "https://api.github.com/users/eps1lon/following{/other_user}",
            "gists_url": "https://api.github.com/users/eps1lon/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/eps1lon",
            "id": 12292047,
            "login": "eps1lon",
            "node_id": "MDQ6VXNlcjEyMjkyMDQ3",
            "organizations_url": "https://api.github.com/users/eps1lon/orgs",
            "received_events_url": "https://api.github.com/users/eps1lon/received_events",
            "repos_url": "https://api.github.com/users/eps1lon/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/eps1lon/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/eps1lon/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/eps1lon"
        }
    },
    {
        "author_association": "CONTRIBUTOR",
        "body": "But one could monkey patch `useState` and detect situations like this. Gonna check my code for other place, which I might missed...\r\n\r\nWorking example: https://codesandbox.io/s/affectionate-cohen-rhzfl?file=/src/index.js",
        "created_at": "2020-06-09T09:38:27Z",
        "html_url": "https://github.com/facebook/react/issues/19103#issuecomment-641168924",
        "id": 641168924,
        "issue_url": "https://api.github.com/repos/facebook/react/issues/19103",
        "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTE2ODkyNA==",
        "performed_via_github_app": null,
        "reactions": {
            "+1": 0,
            "-1": 0,
            "confused": 0,
            "eyes": 0,
            "heart": 0,
            "hooray": 0,
            "laugh": 0,
            "rocket": 0,
            "total_count": 0,
            "url": "https://api.github.com/repos/facebook/react/issues/comments/641168924/reactions"
        },
        "updated_at": "2020-06-09T09:38:27Z",
        "url": "https://api.github.com/repos/facebook/react/issues/comments/641168924",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/582410?v=4",
            "events_url": "https://api.github.com/users/theKashey/events{/privacy}",
            "followers_url": "https://api.github.com/users/theKashey/followers",
            "following_url": "https://api.github.com/users/theKashey/following{/other_user}",
            "gists_url": "https://api.github.com/users/theKashey/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/theKashey",
            "id": 582410,
            "login": "theKashey",
            "node_id": "MDQ6VXNlcjU4MjQxMA==",
            "organizations_url": "https://api.github.com/users/theKashey/orgs",
            "received_events_url": "https://api.github.com/users/theKashey/received_events",
            "repos_url": "https://api.github.com/users/theKashey/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/theKashey/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/theKashey/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/theKashey"
        }
    },
    {
        "author_association": "COLLABORATOR",
        "body": "> But one could monkey patch useState and detect situations like this.\r\n\r\nYou don't know where this value comes from. It could be safe e.g. from a mutable source or context. React itself might be able to do that because it could know that a second setState was triggered from strict mode.\r\n\r\nBut in concurrent mode it's valid to call setState with different values between renders. ",
        "created_at": "2020-06-09T10:47:39Z",
        "html_url": "https://github.com/facebook/react/issues/19103#issuecomment-641207524",
        "id": 641207524,
        "issue_url": "https://api.github.com/repos/facebook/react/issues/19103",
        "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTIwNzUyNA==",
        "performed_via_github_app": null,
        "reactions": {
            "+1": 1,
            "-1": 0,
            "confused": 0,
            "eyes": 0,
            "heart": 0,
            "hooray": 0,
            "laugh": 0,
            "rocket": 0,
            "total_count": 1,
            "url": "https://api.github.com/repos/facebook/react/issues/comments/641207524/reactions"
        },
        "updated_at": "2020-06-09T10:47:39Z",
        "url": "https://api.github.com/repos/facebook/react/issues/comments/641207524",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/12292047?v=4",
            "events_url": "https://api.github.com/users/eps1lon/events{/privacy}",
            "followers_url": "https://api.github.com/users/eps1lon/followers",
            "following_url": "https://api.github.com/users/eps1lon/following{/other_user}",
            "gists_url": "https://api.github.com/users/eps1lon/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/eps1lon",
            "id": 12292047,
            "login": "eps1lon",
            "node_id": "MDQ6VXNlcjEyMjkyMDQ3",
            "organizations_url": "https://api.github.com/users/eps1lon/orgs",
            "received_events_url": "https://api.github.com/users/eps1lon/received_events",
            "repos_url": "https://api.github.com/users/eps1lon/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/eps1lon/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/eps1lon/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/eps1lon"
        }
    },
    {
        "author_association": "CONTRIBUTOR",
        "body": "Well, one should use concurrent mode only after a dozen of checks, `StrickMode` included, completely passed. So monkeypatching some stuff might help a lot, and then be completely removed till next time.",
        "created_at": "2020-06-09T11:02:17Z",
        "html_url": "https://github.com/facebook/react/issues/19103#issuecomment-641215389",
        "id": 641215389,
        "issue_url": "https://api.github.com/repos/facebook/react/issues/19103",
        "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTIxNTM4OQ==",
        "performed_via_github_app": null,
        "reactions": {
            "+1": 0,
            "-1": 0,
            "confused": 0,
            "eyes": 0,
            "heart": 0,
            "hooray": 0,
            "laugh": 0,
            "rocket": 0,
            "total_count": 0,
            "url": "https://api.github.com/repos/facebook/react/issues/comments/641215389/reactions"
        },
        "updated_at": "2020-06-09T11:02:17Z",
        "url": "https://api.github.com/repos/facebook/react/issues/comments/641215389",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/582410?v=4",
            "events_url": "https://api.github.com/users/theKashey/events{/privacy}",
            "followers_url": "https://api.github.com/users/theKashey/followers",
            "following_url": "https://api.github.com/users/theKashey/following{/other_user}",
            "gists_url": "https://api.github.com/users/theKashey/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/theKashey",
            "id": 582410,
            "login": "theKashey",
            "node_id": "MDQ6VXNlcjU4MjQxMA==",
            "organizations_url": "https://api.github.com/users/theKashey/orgs",
            "received_events_url": "https://api.github.com/users/theKashey/received_events",
            "repos_url": "https://api.github.com/users/theKashey/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/theKashey/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/theKashey/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/theKashey"
        }
    },
    {
        "author_association": "CONTRIBUTOR",
        "body": "Anyway, look like this is not a bug, but a feature. I consider my question as fully answered and the problem is absolutely clear now.\r\nIt's not only \"not right\", but actually \"not safe\" to base any logic on refs. If one could do it other, probably immutable way,- they should.",
        "created_at": "2020-06-09T11:08:08Z",
        "html_url": "https://github.com/facebook/react/issues/19103#issuecomment-641218668",
        "id": 641218668,
        "issue_url": "https://api.github.com/repos/facebook/react/issues/19103",
        "node_id": "MDEyOklzc3VlQ29tbWVudDY0MTIxODY2OA==",
        "performed_via_github_app": null,
        "reactions": {
            "+1": 1,
            "-1": 0,
            "confused": 0,
            "eyes": 0,
            "heart": 0,
            "hooray": 0,
            "laugh": 0,
            "rocket": 0,
            "total_count": 1,
            "url": "https://api.github.com/repos/facebook/react/issues/comments/641218668/reactions"
        },
        "updated_at": "2020-06-09T11:08:08Z",
        "url": "https://api.github.com/repos/facebook/react/issues/comments/641218668",
        "user": {
            "avatar_url": "https://avatars.githubusercontent.com/u/582410?v=4",
            "events_url": "https://api.github.com/users/theKashey/events{/privacy}",
            "followers_url": "https://api.github.com/users/theKashey/followers",
            "following_url": "https://api.github.com/users/theKashey/following{/other_user}",
            "gists_url": "https://api.github.com/users/theKashey/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/theKashey",
            "id": 582410,
            "login": "theKashey",
            "node_id": "MDQ6VXNlcjU4MjQxMA==",
            "organizations_url": "https://api.github.com/users/theKashey/orgs",
            "received_events_url": "https://api.github.com/users/theKashey/received_events",
            "repos_url": "https://api.github.com/users/theKashey/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/theKashey/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/theKashey/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/theKashey"
        }
    }
]